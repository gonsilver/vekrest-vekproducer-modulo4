name: workCI/CD Workflow

on:
  push:
    tags: ['v*', 'v*.*', 'v*.*.*']
  workflow_dispatch:

jobs:
  create-release:
    name: Create Release & Generate Changelog
    runs-on: ubuntu-latest
    permissions:
      contents: write
  
    steps:
      - name: â¬‡ï¸ Checkout do CÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
  
      - name: Generate Release Body with Logs
        id: generate_changelog
        run: |
          CURRENT_TAG=${{ github.ref_name }}
  
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 "$CURRENT_TAG^" 2>/dev/null || echo "")
  
          echo "Tag Atual: $CURRENT_TAG"
          echo "Tag Anterior: $PREVIOUS_TAG"
          if [ -z "$PREVIOUS_TAG" ]; then
            LOGS=$(git log --pretty=format:"* %s (%an)" | sed 's/\([A-Za-z0-9]\{7\}\)$//')
            echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
            echo "### ðŸš€ Primeira VersÃ£o" >> $GITHUB_ENV
            echo "" >> $GITHUB_ENV
            echo "Esta Ã© a release inicial do projeto." >> $GITHUB_ENV
            echo "" >> $GITHUB_ENV
            echo "$LOGS" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            LOGS=$(git log $PREVIOUS_TAG..$CURRENT_TAG --pretty=format:"* %s (%an)" | sed 's/\([A-Za-z0-9]\{7\}\)$//')
            echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
            echo "### ðŸ› ï¸ Logs de MudanÃ§as ($PREVIOUS_TAG -> $CURRENT_TAG)" >> $GITHUB_ENV
            echo "" >> $GITHUB_ENV
            echo "$LOGS" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi
  
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          body: ${{ env.RELEASE_BODY }}
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          token: ${{ secrets.GITHUB_TOKEN }}
